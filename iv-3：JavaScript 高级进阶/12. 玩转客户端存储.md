# ç©è½¬å®¢æˆ·ç«¯å­˜å‚¨

cookie, storageï¼ŒindexedDBç­‰å¸¸è§çš„å®¢æˆ·ç«¯ç¼“å­˜ï¼Œäº†è§£å…¶é€‚ç”¨åœºæ™¯ï¼Œå¹¶å°è£…ä¸€äº›é€‚ç”¨çš„å·¥å…·åº“ã€‚ è¿™å½“ç„¶ä¸å¤Ÿï¼Œè¿˜æœ‰å¾ˆå¤šè¿›é˜¶çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚ä½ ä¸çŸ¥é“çš„storageï¼Œstorageæ‰©å®¹ï¼ŒsessionStorageçš„ç›²åŒºç­‰ç­‰

## cookieé«˜çº§ä½¿ç”¨å’Œæ³¨æ„äº‹é¡¹

**å®¢æˆ·ç«¯å†™ Cookie**

```ts
const domNode = document.querySelector(".show-cookie");
getCookie.onclick = function () {
    //è¯»
    domNode.innerText = document.cookie;
};
setCookie.onclick = function () {
    //å†™
    document.cookie = "testUid=test;path=/;";
};

deleteCookie.onclick = function () {
    const expiresTime = new Date(0).toUTCString();
    //ä¿®æ”¹cookieæˆ–è€…åˆ é™¤cookie,éœ€è¦ä¿éšœpathå’Œdomainä¸¤ä¸ªå€¼ä¸å˜ã€‚
    document.cookie = `testUid=test;path=/;expires=${expiresTime};`;
};
```

![](./img/12-01.PNG)

æ³¨æ„ç‚¹ï¼š

- åˆ é™¤ cookie ï¼Œè®¾ç½® cookie çš„è¿‡æœŸæ—¶é—´ä¸ºè¿‡å»æ—¶é—´å³å¯
- è®¾ç½®å¤šä¸ª cookieï¼Œå¤šæ¬¡è°ƒç”¨ document.cookie
- ä¿®æ”¹cookieæˆ–è€…åˆ é™¤cookie,éœ€è¦ä¿éšœpathå’Œdomainä¸¤ä¸ªå€¼ä¸å˜ã€‚


**æœåŠ¡ç«¯å†™ Cookie**

```ts
//è®¾ç½®cookie
res.setHeader('Set-Cookie', ['userToken=1111;Max-Age=86400;']);
// æˆ–è€…
res.cookie("cid", '555', { maxAge: 86400, httpOnly: true });
```

![](./img/12-02.PNG)

**Cookie çš„å‡ ä¸ªç‰¹æ®Šé€‰å‹**

![](./img/12-03.PNG)

**ä¼šè¯æœŸ cookie**

- å®šä¹‰ï¼šæµè§ˆå™¨ä¼šè¯æœŸé—´çš„ cookieï¼Œæµè§ˆå™¨å…³é—­ä»¥åè‡ªåŠ¨åˆ é™¤ã€‚
- è®¾ç½®ä¼šè¯æœŸ cookieï¼šä¸æŒ‡å®šè¿‡æœŸæ—¶é—´(Expires)å’Œæœ‰æ•ˆæœŸ(Max-Age)å³å¯

**æŒä¹…åŒ– cookie**

- å®šä¹‰ï¼šæŒä¹…åŒ– cookie çš„ç”Ÿå‘½å‘¨æœŸå–å†³äºè¿‡æœŸæ—¶é—´(Expires)å’Œæœ‰æ•ˆæœŸ(Max-Age),æŒä¹…åŒ– cookie å­˜å‚¨åœ¨å®¢æˆ·ç«¯ç¡¬ç›˜ä¸­ã€‚
- Max-Ageï¼šæ­£æ•°ï¼Œcookie æŒä¹…åŒ–æ—¶é—´ï¼Œå•ä½ç§’
- Max-Ageï¼š0 ï¼Œå¯ä»¥åˆ é™¤ cookie

**httpOnly**

- å®šä¹‰ï¼šè®¾ç½®ä¸º trueï¼Œå¯ä»¥é˜»æ­¢é€šè¿‡ js è®¿é—®cookieã€‚èƒ½æœ‰æ•ˆçš„é˜²æ­¢ XSS æ”»å‡»
- document.cookie æ— æ³•è®¿é—®

**secure**
- å®šä¹‰ï¼šè®¾ç½®ä¸º trueï¼Œcookie åªä¼šè¢«https ä¼ è¾“åˆ°æœåŠ¡ç«¯ã€‚

**cookieçš„ä½œç”¨åŸŸ**

![](./img/12-04.PNG)

**cookieåŒæºå’ŒåŒç«™åŒºåˆ«**

- åŒæºï¼šåè®® + ç«¯å£ + åŸŸå
- åŒç«™ï¼šæœ‰æ•ˆé¡¶çº§åŸŸå+äºŒçº§åŸŸåï¼Œä¸è€ƒè™‘ç«¯å£å’Œåè®®


åŒç«™
```ts
// a.taobao.com b.taobao.com
// 127.0.0.1:8000 127.0.0.1:443
```

è·¨ç«™ï¼š
```ts
// a.github.io b.github.io
// github.io å±äºä¸€ä¸ªæœ‰æ•ˆçš„é¡¶çº§åŸŸå
```

**SameSite è·¨ç«™æºå¸¦ cookie**

![](./img/12-05.PNG)

![](./img/12-06.PNG)

æ³¨æ„äº‹é¡¹ï¼š
- SameSite å¿…é¡»å’Œ Secur åŒäº‹è®¾ç½®æ‰ç”Ÿæ•ˆ
- å‰ç«¯ç«™ç‚¹å’Œåç«¯æ¥å£ä¸º https

**key å’Œ value ç¼–è§£ç **

ä¸ºä»€ä¹ˆè¦ç¼–è§£ç ï¼Ÿ

- key å’Œ value ä¸­å‡ºç°äº†åˆ†å·ï¼Œç­‰å·ç­‰ç‰¹æ®Šç¬¦å·ï¼Œå½±å“æˆ‘ä»¬è§£ææ“ä½œ

```ts
const key=encodeURIComponent("testUid");
const value=encodeURIComponent("test=1");
document.cookie=`${key}=${value};path=/;`
```

**æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¦ç”¨ cookie**

![](./img/12-07.PNG)

```ts
window.navigator.cookieEnabled
```

**ç¼–å†™ cookie å·¥å…·åº“**

CookieUtils.js
```ts
/**
 *
 * ç¼–ç  -æ–¹ä¾¿åç»­æ›¿æ¢ç¼–è§£ç æ–¹æ³•
 * @param {any} s
 * @returns
 */
function encode(s) {
  return encodeURIComponent(s);
}
/**
 *
 * è§£ç -æ–¹ä¾¿åç»­æ›¿æ¢ç¼–è§£ç æ–¹æ³•
 * @param {any} s
 * @returns
 */
function decode(s) {
  return decodeURIComponent(s);
}

/**
 *
 * è·å–cookie
 * @param {any} key
 * @returns
 */
function getCookieItem(key) {
  let result = key ? undefined : {},
    cookies = document.cookie ? document.cookie.split("; ") : [],
    i = 0,
    l = cookies.length;
  for (; i < l; i++) {
    let parts = cookies[i].split("="),
      //å–ç¬¬ä¸€ä¸ªç­‰å·å‰é¢çš„ä½œä¸ºkey
      name = decode(parts.shift()),
      cookie = parts.join("=");

    if (key === name) {
      result = decode(cookie);
      break;
    }

    if (!key && cookie !== undefined) {
      //key æœªå®šä¹‰ï¼Œè¿”å›å…¨éƒ¨çš„keyå’Œvalueå¯¹è±¡
      result[name] = decode(cookie);
    }
  }
  return result;
}

/**
 *
 * è®¾ç½®cookie
 * @param {any} key
 * @param {any} value
 * @param {any} [options={}]
 * @returns
 */
function setCookieItem(key, value, options = {}) {
  if (!key) return false;
  console.log(options);

  let sExpires = "";
  if (options.expires) {
    switch (options.expires.constructor) {
      case Number:
        sExpires =
          options.expires === Infinity
            ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT"
            : "; max-age=" + options.expires;
        break;
      case String:
        sExpires = "; expires=" + options.expires;
        break;
      case Date:
        sExpires = "; expires=" + options.expires.toUTCString();
        break;
    }
  }

  window.document.cookie = [
    encode(key),
    "=",
    encode(value),
    sExpires,
    options.path ? "; path=" + options.path : "",
    options.domain ? "; domain=" + options.domain : "",
    options.secure ? "; secure" : "",
  ].join("");
  return true;
}

/**
 *
 * ç§»é™¤å•ä¸ªcookieå­—æ®µ
 * @param {any} key
 * @param {any} options
 * @returns
 */
function removeCookieItem(key, options) {
  setCookieItem(key, "", { ...options, expires: -1 });
  return !getCookieItem(key);
}
```

use:
```ts
const cookieOption={
    path:"/",
    domain:"127.0.0.1",
    expires:15
};
const domNode= document.querySelector(".show-cookie");
getCookie.onclick=function(){
    domNode.innerText=document.cookie;
}
setCookie.onclick=function(){
    setCookieItem("testUid","test=222=1",cookieOption)
}

getSingleCookie.onclick=function(){
    domNode.innerText=getCookieItem("testUid");
    console.log(getCookieItem())
}

deleteCookie.onclick=function(){
    removeCookieItem("testUid",cookieOption)
}
```

**æ–°å¼‚æ­¥æ“ä½œ CookieAPI - cookieStore**

- set: è®¾ç½® cookieï¼Œå¯ä»¥æ˜¯ set(name, value)ï¼Œä¹Ÿå¯ä»¥æ˜¯ set({name, value})ï¼›
- get: è·å– cookieï¼Œå¯ä»¥æ˜¯ get(name)ï¼Œæˆ–è€… get({name});
- getAll: è·å–æ‰€æœ‰çš„ cookieï¼›
- delete: åˆ é™¤ cookieï¼›
- onchange: ç›‘å¬ cookie çš„å˜åŒ–ï¼›

![](./img/12-08.PNG)

```ts
// è®¾ç½®
cookieStore
  .set('username', 'meizi')
  .then(() => console.log('è®¾ç½®usernameæˆåŠŸ'))
  .catch(() => console.error('è®¾ç½®usernameå¤±è´¥'));

cookieStore
  .set({
    name: 'age',
    value: 18,
    expires: new Date().getTime() + 24 * 60 * 60 * 1000,
  })
  .then(() => console.log('è®¾ç½®ageæˆåŠŸ'))
  .catch(() => console.error('è®¾ç½®ageå¤±è´¥'));

// è·å–æŒ‡å®š
const username = await cookieStore.get('username');

// è·å–æ‰€æœ‰
const all = await cookieStore.getAll();

// åˆ é™¤
cookieStore
  .delete('age')
  .then(() => console.log('åˆ é™¤ageæˆåŠŸ'))
  .catch(() => console.error('åˆ é™¤ageå¤±è´¥'));

// ç›‘å¬å˜åŒ–
cookieStore.addEventListener('change', (event) => {
  const type = event.changed.length ? 'change' : 'delete';
  const data = (event.changed.length ? event.changed : event.deleted).map((item) => item.name);

  console.log(`åˆšæ‰è¿›è¡Œäº† ${type} æ“ä½œï¼Œcookieæœ‰ï¼š${JSON.stringify(data)}`);
});


const isSupportCookieStore = typeof cookieStore === 'object' && location.protocol === 'https:'; // åªæœ‰åœ¨httpsåè®®ä¸‹æ‰ä½¿ç”¨cookieStore
```

åœ¨ service worker ä¸­ä½¿ç”¨:

sw.js:
```ts
self.addEventListener("install", async (event) => {
  console.log("service worker is installed");
  const subscriptions = await self.registration.cookies.getSubscriptions();
  await self.registration.cookies.unsubscribe(subscriptions);

  await self.registration.cookies.subscribe([
    {
      name: "cookie-x",
    },
  ]);
});

// ç›‘å¬å˜åŒ–
self.addEventListener("cookiechange", (ev) => {
  console.log("service worker cookiechange:", ev.changed, ev.deleted);
});

console.log("service worker !!!!");
```

cookieStore æ³¨æ„äº‹é¡¹:
- å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨: æ¯”å¦‚ https\localhost ç­‰
- è¿”å›çš„éƒ½æ˜¯ Promise
- Firefox å’Œ Safari æš‚ä¸æ”¯æŒ

## åƒå®š Web Storage

![](./img/12-09.PNG)

**sessionStorage VS localStorage**

![](./img/12-10.PNG)
- éƒ½éµå¾ªåŒæºç­–ç•¥
- å®¹é‡ä¸€æ ·


æ³¨æ„äº‹é¡¹ï¼š

![](./img/12-11.PNG)

```ts
const arr = Array.from({ length: 5.12 * 1024 * 33 }, (v, index) => ({
    name: "name" + index,
    age: ~~(Math.random() * 100)
}));
btnAdd.onclick = function () {
    console.time(`å­˜`)
    const str = JSON.stringify(arr);
    localStorage.setItem('_', str);
    console.timeEnd(`å­˜`)
}
btnGet.onclick = function () {
    console.time(`å–é•¿åº¦${str.length}`)
    localStorage.getItem('_')
    console.timeEnd(`å–é•¿åº¦${str.length}`)
}
```

**sessionStroage æ˜¯å…±äº«çš„å—**

![](./img/12-12.PNG)

æ³¨æ„ a æ ‡ç­¾çš„ rel="opener"
```html
<a href="./other.html" target="_blank">æ‰“å¼€æ–°é¡µé¢</a>
<a href="./other.html" target="_blank" rel="opener">æ‰“å¼€æ–°é¡µé¢</a>
```

![](./img/12-13.PNG)


StorageEventï¼š

![](./img/12-14.PNG)

sessionStorage èƒ½è§¦å‘ StorageEvent äº‹ä»¶å—ï¼Ÿ

- a æ ‡ç­¾æ‰“å¼€ï¼Œä¸èƒ½è§¦å‘
- iframe åµŒå¥—ï¼šèƒ½è§¦å‘
- sessionStorage å’Œ localStorage éƒ½èƒ½è§¦å‘ StorageEventï¼Œæ€ä¹ˆåŒºåˆ†æ˜¯è°è§¦å‘çš„

![](./img/12-15.PNG)


**localStorage æ”¯æŒè¿‡æœŸï¼šç®€å•çš„å®ç°**

- æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œè®°ä½è¿‡æœŸçš„æ—¶é—´
- æ·»åŠ æ•°æ®çš„æ—¶å€™ï¼Œä¸€èµ·ä¿å­˜
- æŸ¥è¯¢æ•°æ®ï¼Œå¯¹æ¯”æ—¶é—´ï¼Œè¿‡æœŸåˆ é™¤

```html
<body>
    <script>
        const myLocalStore = {
            setItem: (key, value, expire) => {
                const lsValue = JSON.parse(localStorage.getItem(key) || '{}');
                localStorage.setItem(
                    key,
                    JSON.stringify({
                        ...lsValue,
                        value,
                        expire
                    }))
            },
            getItem: (key) => {
                //Â åœ¨å–å€¼ä¹‹å‰å…ˆåˆ¤æ–­æ˜¯å¦è¿‡æœŸ
                const lsValue = JSON.parse(
                    localStorage.getItem(key) || "{}"
                )
                if (lsValue.expire && lsValue.expire >= Date.now()) {
                    return lsValue.value
                } else {
                    localStorage.removeItem(key)
                    return null
                }
            }
        }

    </script>

    <script>
        btnSetItem.onclick = function () {
            myLocalStore.setItem('key-x', 'value-1', Date.now() + 10000);
        }
        btnGetItem.onclick = function () {
            console.log("getItem:", myLocalStore.getItem('key-x'));
        }
    </script>
</body>
```

ç¬¬ä¸‰æ–¹åº“: web-storage-cache

![](./img/12-16.PNG)

**localStorage å­˜å‚¨åŠ å¯†ï¼šç®€å•åŠ å¯†**

- URL æ–¹å¼ï¼šencodeURIComponent + decodeURIComponent
- base64: window.btoa + window.atob

![](./img/12-17.PNG)


**å¤æ‚åŠ å¯†**

- Web Crypto API çš„ SubtlrCrypto æ¥å£æä¾›äº†è®¸å¤šåº•å±‚åŠ å¯†åŠŸèƒ½

```ts
<body>
    <div class="flex">
        <div class="side">
            <div>åŠ å¯†å‰å†…å®¹</div>
            <div>
                <textarea id="textAreaClearText"></textarea>
            </div>
        </div>
        <div>
            <div>åŠ å¯†åå†…å®¹</div>
            <div>
                <textarea id="textAreaCipherText"></textarea>
            </div>
        </div>
    </div>

    <div>
        <button type="button" id="btnEncrypt">åŠ å¯†</button>
        <button type="button" id="btnDecrypt">è§£å¯†</button>
    </div>

    <script>
        let publicKey;
        let privateKey;

        let arrayBuffer;
        (async function init() {
            // ç”Ÿæˆç§é’¥(privateKey)å’Œå…¬é’¥(publicKey)
            // åŠ å¯†ç”¨å…¬é’¥ï¼Œ è§£å¯†ç”¨ç§é’¥
            const keyPair = await crypto.subtle.generateKey(
                {
                    name: "RSA-OAEP",
                    modulusLength: 2048,
                    publicExponent: new Uint8Array([1, 0, 1]),
                    hash: "SHA-256",
                },
                true,
                ["encrypt", "decrypt"]
            );
            publicKey = keyPair.publicKey;
            privateKey = keyPair.privateKey;
        })();

        /**
         * è¿”å›ArrayBuffer
         */
        function encrypt(text, publicKey) {
            // å­—ç¬¦ä¸²è½¬ä¸ºTypedArray
            const clearText = new TextEncoder().encode(text);
            return window.crypto.subtle.encrypt(
                {
                    name: "RSA-OAEP",
                },
                publicKey,
                // an ArrayBuffer, or a TypedArray
                clearText
            );
        }

        /**
         *  cipherText: ArrayBuffer
         *
         */
        async function decrypt(cipherText, privateKey) {
            // cipherText æ˜¯ArrayBuffer
            let decrypted = await window.crypto.subtle.decrypt(
                {
                    name: "RSA-OAEP",
                },
                privateKey,
                cipherText
            );
            const dec = new TextDecoder();
            return dec.decode(decrypted);
        }

        btnEncrypt.onclick = async () => {
            const text = textAreaClearText.value;
            arrayBuffer = await encrypt(text, publicKey);

            // ArrayBufferè½¬ä¸ºå­—ç¬¦ä¸²
            const dec = new TextDecoder();
            textAreaCipherText.value = dec.decode(arrayBuffer);
            console.log("arrayBuffer:", arrayBuffer);
        };

        btnDecrypt.onclick = async () => {
            const text = await decrypt(arrayBuffer, privateKey);
            textAreaClearText.value = text;
        };
    </script>
</body>
```

**ä½¿ç”¨åŠ å¯†åº“**

- crypto-js

![](./img/12-18.PNG)

ä¼ é€é—¨ï¼šhttps://github.com/ShenBao/rsa-aes-utils

- secure-ls

![](./img/12-19.PNG)

- localstorage-slim

![](./img/12-20.PNG)

**Web Storage çš„å­˜å‚¨ç©ºé—´**

localStorage å­˜å‚¨çš„é”®å€¼é‡‡ç”¨ä»€ä¹ˆå­—ç¬¦ç¼–ç ï¼Ÿ
- ç­”æ¡ˆï¼šUTF-16
- UTF-16ï¼Œæ¯ä¸ªå­—ç¬¦ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼Œæ˜¯æœ‰å‰ææ¡ä»¶çš„ï¼Œå°±æ˜¯ç ç‚¹å°äº 0xFFFF(65535) , å¤§äºè¿™ä¸ªç ç‚¹çš„å°±æ˜¯å››ä¸ªå­—èŠ‚ã€‚

**5Mçš„å•ä½æ˜¯ä»€ä¹ˆ**

![](./img/12-21.PNG)

**localStorage é”®å ä¸å ç©ºé—´**

- ç­”æ¡ˆï¼šå 

```html
<body>

    <button type="button" id="btnSave">ä¿å­˜</button>
    <script>
        btnSave.onclick = function () {
            const charTxt = "a";
            let count = (2.5 * 1024 * 1024);
            let content = Array.from({ length: count }, _ => charTxt).join("");
            const key = Array.from({ length: count }, _ => charTxt).join("")
            localStorage.clear();
            try {
                console.time("setItem")
                localStorage.setItem(key, content);
                // localStorage.setItem(key, content + '_');
                console.timeEnd("setItem")
            } catch (err) {
                console.log("err code:", err.code);
                console.log("err message:", err.message)
            }
        }
    </script>

</body>
```

## indexedDB çš„ç²¾åå’Œä½¿ç”¨

![](./img/12-22.PNG)

ä»€ä¹ˆæ˜¯ indexedDB
- ä¸€ä¸ª`äº‹åŠ¡å‹`æ•°æ®åº“ç³»ç»Ÿ
- ä¸€ä¸ªåŸºäº JS çš„é¢å‘å¯¹è±¡æ•°æ®åº“
- æ”¯æŒç´¢å¼•
- å¯ä»¥å­˜å‚¨`ç»“æ„åŒ–å…‹éš†ç®—æ³•`æ”¯æŒçš„ä»»ä½•å¯¹è±¡

ä¸èƒ½è¢«ç»“æ„åŒ–å…‹éš†ç®—æ³•å¤åˆ¶çš„æ•°æ®
- Error æˆ–è€… Function å¯¹è±¡
- DOM èŠ‚ç‚¹
- å±æ€§æè¿°ç¬¦ã€setters ä»¥åŠ getters
- åŸå‹é“¾ä¸Šçš„å±æ€§

MDNï¼š https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm#%E7%BB%93%E6%9E%84%E5%8C%96%E5%85%8B%E9%9A%86%E6%89%80%E4%B8%8D%E8%83%BD%E5%81%9A%E5%88%B0%E7%9A%84

ç‰¹ç‚¹ï¼š
- ä»¥é”®å€¼å¯¹æ–¹å¼å­˜å‚¨ï¼Œé”®å¯ä»¥æ˜¯äºŒè¿›åˆ¶å¯¹è±¡
- æ”¯æŒäº‹åŠ¡
- å¼‚æ­¥æ“ä½œã€‚åŸºäºå›è°ƒå‡½æ•°çš„å¼‚æ­¥ï¼Œä¸æ˜¯ Promise
- éµå¾ªåŒæºç­–ç•¥
- å­˜å‚¨ç©ºé—´é…é¢å¾ˆå¤§
- æ”¯æŒç›´æ¥å­˜å‚¨äºŒè¿›åˆ¶å†…å®¹

**indexedDB ä¸»è¦å¯¹è±¡æ¨¡å‹**

![](./img/12-23.PNG)

åŸºæœ¬æ“ä½œæµç¨‹
1. æ‰“å¼€æ•°æ®åº“
2. åœ¨æ•°æ®åº“ä¸­å·®UNä¸ªhiå®‰/å¯¹å¼€ä¸€ä¸ªå¯¹è±¡ä»“åº“
3. å¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å‘é€ä¸€ä¸ªè¯·æ±‚æ¥æ‰§è¡Œä¸€ä¸‹æ•°æ®åº“æ“ä½œï¼Œåƒå¢åŠ æˆ–æå–æ•°æ®ç­‰
4. é€šè¿‡ç›‘å¬äº‹ä»¶ä»¥ç­‰å¾…æ“ä½œå®Œæˆ
5. ç»§ç»­åç»­çš„æ“ä½œ

![](./img/12-24.PNG)

```html
<body>
  <div>
    <button id="btnAdd">æ·»åŠ æ•°æ®</button>
    <button id="btnQuery">æŸ¥è¯¢æ•°æ®</button>
  </div>
  <script>
    // https://github.com/mdn/indexeddb-examples/blob/master/idbkeyrange/scripts/main.js
    var db;
    var things = [
      { fThing: "Drum kit", fRating: 10 },
      { fThing: "Family", fRating: 10 },
      { fThing: "Batman", fRating: 9 },
      { fThing: "Brass eye", fRating: 9 },
      { fThing: "The web", fRating: 9 },
      { fThing: "Mozilla", fRating: 9 },
      { fThing: "Firefox OS", fRating: 9 },
      { fThing: "Curry", fRating: 9 },
      { fThing: "Paneer cheese", fRating: 8 },
      { fThing: "Mexican food", fRating: 8 },
      { fThing: "Chocolate", fRating: 7 },
      { fThing: "Heavy metal", fRating: 10 },
      { fThing: "Monty Python", fRating: 8 },
      { fThing: "Aphex Twin", fRating: 8 },
      { fThing: "Gaming", fRating: 7 },
      { fThing: "Frank Zappa", fRating: 9 },
      { fThing: "Open minds", fRating: 10 },
      { fThing: "Hugs", fRating: 9 },
      { fThing: "Ale", fRating: 9 },
      { fThing: "Christmas", fRating: 8 },
    ];

    // æ’å…¥æ•°æ®
    function insertData() {
      // äº‹åŠ¡
      var transaction = db.transaction(["fThings"], "readwrite");
      // å¯¹è±¡åº“
      var objectStore = transaction.objectStore("fThings");
      // æ·»åŠ æ•°æ®
      for (i = 0; i < things.length; i++) {
        var request = objectStore.put(things[i]);
      }
      // æˆåŠŸçš„å›è°ƒ
      transaction.oncomplete = function () {
        console.log("insert data success");
      };
    }

    // æˆ‘ä»¬å…ˆæ‰“å¼€ä¸€ä¸ªæ•°æ®åº“, window.indexedDB(IDBFactory)
    const openRequest = window.indexedDB.open("fThings", 1);
    // å‡çº§çš„æ—¶å€™åˆ›å»ºå¯¹è±¡åº“å’Œå¯¹åº”çš„ç´¢å¼•
    openRequest.onupgradeneeded = function (event) {
      var db = event.target.result;
      db.onerror = function (event) {
        console.log("Error loading database");
      };
      var objectStore = db.createObjectStore("fThings", {
        keyPath: "fThing",
      });
      objectStore.createIndex("fRating", "fRating", { unique: false });
    };

    openRequest.onerror = function (event) {
      console.log("open error:", event);
    }

    openRequest.onsuccess = function (event) {
      console.log("open success");
      // è·å¾—database
      db = event.target.result;
    };

    btnQuery.onclick = function () {
      // äº‹åŠ¡
      const transaction = db.transaction(["fThings"], "readonly");
      // å¯¹è±¡åº“
      const objectStore = transaction.objectStore("fThings");
      // é”®
      const keyRangeValue = IDBKeyRange.bound("A", "F");
      // æ¸¸æ ‡
      objectStore.openCursor(keyRangeValue).onsuccess = function (event) {
        var cursor = event.target.result;
        if (cursor) {
          console.log("value:", cursor.value);
          cursor.continue();
        } else {
          console.log("Entries all displayed.");
        }
      };
    };

    btnAdd.onclick = insertData;

  </script>
</body>
```

å®ç”¨åœºæ™¯ï¼š
- ç¼“å­˜æ•°æ®ï¼Œæ¯”å¦‚æ¸¸æˆæ•°æ®
- ç¼“å­˜å›¾ç‰‡ï¼Œè„šæœ¬ï¼Œjson æ–‡ä»¶ç­‰é™æ€èµ„æº
- service worker çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå°±æœ‰åˆ©ç”¨åˆ° indexedDB

ç¬¬ä¸‰æ–¹åº“ï¼š

- localForage
 
![](./img/12-25.PNG)

- dexie.js

![](./img/12-26.PNG)

- ZangoDB

![](./img/12-27.PNG)

- JsStore

![](./img/12-28.PNG)


åŸºäº IndexedDB çš„æ–‡ä»¶ç³»ç»Ÿ

![](./img/12-29.PNG)


## å®¢æˆ·ç«¯å­˜å‚¨ å¤§æ¯”æ‹¼

![](./img/12-30.PNG)

![](./img/12-31.PNG)

![](./img/12-32.PNG)

![](./img/12-33.PNG)

![](./img/12-34.PNG)

LocalStorageï¼š

![](./img/12-35.PNG)

```ts
lBtn.onclick=function(){
    const charTxt = "äºº";
    let count = (10 * 1024 * 1024) / 2 - 8 / 2;
    let content = new Array(count).fill(charTxt).join("");
    const key = "aağŸ”´";
    const key1 = "bbğŸ”´";
    localStorage.clear();
    try {
        localStorage.setItem(key, content);
        //æµ‹è¯•å­˜å‚¨æ˜¯å¦ä¸æ•°é‡æœ‰å…³ã€‚
        localStorage.setItem(key1, content);
    } catch (err) {
        console.log("err",err.code ,err, );
    }
    const sizeKey = sizeofUtfBytes(key,"utf16");
    const contentSize = sizeofUtfBytes(content,"utf16");
    console.log("key size:", sizeKey, content.length);
    console.log("content size:", contentSize, content.length);
    console.log("total size:", sizeKey + contentSize, content.length + key.length);
}
```

sessionStorage:

![](./img/12-36.PNG)

```ts
sBtn.onclick=function(){
    const charTxt = "äºº";
    let count = (10 * 1024 * 1024) / 2 - 8 / 2;
    let content = new Array(count).fill(charTxt).join("");
    const key = "bbğŸ”´";
    const key1 = "ccğŸ”´";
    sessionStorage.clear();
    try {
        sessionStorage.setItem(key, content);
        sessionStorage.setItem(key1, content);
    } catch (err) {
        console.log("err", err);
    }
    const sizeKey = sizeofUtfBytes(key,"utf16");
    const contentSize = sizeofUtfBytes(content,"utf16");
    console.log("key size:", sizeKey, content.length);
    console.log("content size:", contentSize, content.length);
    console.log("total size:", sizeKey + contentSize, content.length + key.length);
}
```

IndexedDBï¼š

![](./img/12-37.PNG)

Cache API ä¸ Service workerï¼š

![](./img/12-38.PNG)

FileSystem(éæ ‡å‡†)

![](./img/12-39.PNG)

```html
<body>
    <button id="saveFile">å­˜å‚¨æ–‡ä»¶</button>
    <script>
        //1. è·å–fileSystem å¯¹è±¡
        window.requestFileSystem = window.requestFilsSystem || window.webkitRequestFileSystem;

        saveFile.onclick = function () {
            //2. ç”³è¯·ç©ºé—´å¤§å°
            window.requestFileSystem(
                Window.TEMPORARY,
                10 * 1024 * 1024,
                (fs) => {
                    //3. åˆ›å»ºæ–‡ä»¶
                    fs.root.getFile(
                        "test1.txt",
                        { create: true, exclusive: false },
                        (fileEntry) => {
                            //æ‰“å°åˆ›å»ºå¥½çš„æ–‡ä»¶è®¿é—®URL
                            console.log(fileEntry.toURL())
                            //4. åˆ›å»ºä¸€ä¸ªå†™å…¥å¯¹è±¡
                            fileEntry.createWriter((fileWriter) => {
                                //æ³¨å†Œä¹¦å†™æˆåŠŸç›‘å¬
                                fileWriter.onwriteend = function (e) {
                                    console.log("ä¹¦å†™æˆåŠŸ");
                                };
                                fileWriter.onerror = function (e) {
                                    console.log("ä¹¦å†™å¤±è´¥ " + e.toString());
                                };
                                var blob = new Blob(
                                    [
                                        "æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„æµ‹è¯•å·²ä¸‹é˜¿å¤§çº²çš„",
                                    ],
                                    { type: "text/plain" }
                                );
                                //5. å†™å…¥å†…å®¹
                                fileWriter.write(blob);
                            });
                        },
                        (e) => {
                            console.log("eee", e);
                        }
                    );
                },
                (err) => {
                    console.log("file error");
                }
            );
        };
    </script>
</body>
```

æ€»ç»“ï¼š

![](./img/12-40.PNG)
