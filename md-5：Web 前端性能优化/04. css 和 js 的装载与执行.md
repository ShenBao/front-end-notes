# css 和 js 的装载与执行

![03.png](./img/03.png)

HTML 渲染过程的一些特点：

- 顺序执行、并发加载
  - 词法分析
  - 并发加载
  - 并发上限
- 是否阻塞
  - css 阻塞
    - css head 中阻塞页面的渲染
    - css 阻塞 js 的执行
    - css 不阻塞外部脚本的加载
  - js 阻塞
    - 直接引入的 js 阻塞页面的渲染
    - js 不阻塞资源的加载
    - js 顺序执行，阻塞后续 js 逻辑的执行
- 依赖关系
  - 页面渲染依赖于 css 的加载
  - js 的执行顺序的依赖关系
  - js 逻辑对于 dom 节点的依赖关系
- 引入方式
  - 直接引入
  - defer
  - async
  - 异步动态引入 js

加载和执行的一些优化点：

- css 样式表置顶
- 用 link 代替 import
- js 脚本置底
- 合理使用 js 的异步加载能力

## 一个网页在浏览器中是如何被渲染的？

html ---> DOM、CSS ---> CSSOM

- 通过 http 请求回来的首先是 html 文本。
- html 文本会从一个`字节流---> 字符流`。在浏览器端拿到的实际上是一个字符流。
- 浏览器的 html parser 经过`词法分析`，将相应的字符--->token。将这些 token 不断的添加到 DOM 树中。
- html 解析的特点：**从上到下**进行词法分析，DOM 树就是由从上到下的词法分析的过程中，通过生成的 token 逐渐生成的。
- 在这个过程中，可能会遇到相应的资源标签如 link、script，此时浏览器就会**并发地**像 webserver 或者 cdn 请求相关的静态资源。
- 请求回来的 css 资源，再对 css 进行解析---> cssOM
- DOM + cssOM 结合----> render tree ---> layout ----> paint
- 请求回来的 js 资源，会由浏览器的 v8 引擎执行。

理解网页在浏览器中如何渲染，是浏览器渲染层面进行前端优化的基础。

特点：

- 顺序执行、并发加载
  - 顺序执行就是指，词法分析是**从上到下**进行的
  - 并发加载就是指 css、js 等这些外部资源在浏览器中是**并发地**加载的。
    并发度是受浏览器并发数量限制的。
- 是否阻塞（重要）
- 依赖关系
  - 是指 html 在渲染的过程中，是否存在并遵循了正确的依赖关系。
  - css 代码要在什么地方引入？避免页面闪动问题
    - 有时候 html 页面出来，css 样式并没有加载完成，会出现闪动一下样式加载完成的情况。
    - 这种情况是因为没有遵循好依赖关系，如果把 css 放到 head 中的话，那么整个页面的渲染就会等待 css 加载完并生成 cssOM 后，与 DOM 树 整合成 render tree 之后才会进行页面的渲染。这样渲染出来的页面才会是带有样式的。就不会出现 css 闪动的问题。
  - js 的执行顺序是否有依赖关系？
    - 有时可以通过 script 标签的 async 属性，让 js 异步加载，从而不阻塞 DOM 的渲染。
    - 但 async 的本质是放弃了 js 之间的依赖关系，它的原理是：哪个 js 先加载完就先执行哪个。
    - （默认情况下，html 会按照从上到下的顺序来加载并执行脚本，在脚本加载&执行的过程中，会阻塞后续 DOM 的渲染。）
- 引入方式
  - css 使用 link 引入与 import 引入的区别？哪种更优？
  - js 的引入方式：普通引入、async 引入、defer 引入、动态引入（对于现代化前端非常重要）

## css 阻塞

1. head 中的 css 会阻塞页面的渲染。
   - css 如果在 head 中通过 link 的方式引入的话，页面就会等待 css 加载并解析生成 cssOM 之后，才会进行渲染。
2. css 会阻塞 js 的执行
   - 因为 js 的执行有可能就是依赖于当前 css 的一些属性，如果 css 没有加载完，而执行 js 的话，是会有问题的。
   - 所以 css 阻塞 js 执行，逻辑上是正确的。
3. css 不会阻塞 js 的加载
   - webkit 有一个 preload scanner 预资源加载器。
   - **对于外部资源的加载，css 是不会阻塞的。但会阻塞执行。**

## js 阻塞

1. 普通引入（不使用 async、defer，而直接使用 script）的 js 会阻塞页面的渲染
   - js 很有可能会修改 DOM 结构的，所以 **js 的执行会阻塞后续 DOM 节点的创建**。
   - 这是符合逻辑的。（因为如果它在修改文档结构，会影响后续文档结构的分析）
2. js 不阻塞外部资源的加载
   - webkit 有一个 preload scanner 预资源加载器：它的主要作用是在页面解析过程中提前发现并加载页面中可能需要的资源，从而提高页面加载速度和性能。
   - 对于外部资源的加载，js 是不会阻塞的。
3. js 顺序执行，阻塞后续 js 逻辑的执行
   - js 是单线程的。
   - js 会依据引入时的依赖关系而顺序执行。
   - 这是非常好的，符合逻辑的。

## async 与 defer

script 标签用于加载脚本与执行脚本，在前端开发中可以说是非常重要的标签了。

直接使用 script 脚本的话，**html 会按照从上到下的顺序来加载并执行脚本，在脚本加载&执行的过程中，会阻塞后续 DOM 的渲染**。

> 现在大家习惯于在页面中引用各种的第三方脚本，如果第三方服务商出现了问题，比如 延迟之类的，就会使得页面白屏。
> 好在 script 提供了两种方式来解决上述问题， async 和 defer ，这两个属性使得 script 都不会阻塞 DOM 的渲染。但既然会存在这两个属性，那么就说明，这两个属性之间肯定是有差异的。

async：

- async 的设置，会使 script 脚本异步加载并**在允许的情况下执行**。
- 换句话说， async 的执行，并不会按着 script 在页面中的顺序来执行，而是谁先加载完谁先执行。
- async 舍弃了 script 脚本之间的依赖关系。而是谁先加载完谁先执行。

defer：

- defer 的设置，会使 script 脚本异步加载；
- 如果有多个 defer 属性的 script 标签存在，则会按照**顺序执行** 所有 script
- defer 脚本会在**文档渲染完后，DOMContentLoaded 之前**执行。
